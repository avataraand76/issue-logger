// Code.gs version 4 26/08/2024

function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Sheet1");
  
  var data = JSON.parse(e.postData.contents);
  
  var vietnamTime = Utilities.formatDate(new Date(), "Asia/Ho_Chi_Minh", "HH:mm MM/dd/yyyy");
  
  var teamLeaders = data.teamLeader.split("\n").join("\n");
  
  var stations = data.stationNumber.split(", ");
  
  stations.forEach(function(station) {
    var rowData = [
      vietnamTime,
      data.lineNumber,
      station,
      data.scope,
      teamLeaders,
      data.responsiblePerson,
      "supervisorReport"  // Add this new column to distinguish supervisor reports
    ];
    
    sheet.appendRow(rowData);
  });
  
  return ContentService.createTextOutput(JSON.stringify({status: "success"}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Sheet1");
  var data = sheet.getDataRange().getValues();
  
  var issues = data.slice(1).map(function(row, index) {
    return {
      id: index + 1,
      submissionTime: row[0],
      lineNumber: row[1],
      stationNumber: row[2],
      scope: row[3],
      teamLeader: row[4],
      responsiblePerson: row[5],
      type: row[6] || "issue"  // Use the new column to set the type
    };
  });
  
  return ContentService.createTextOutput(JSON.stringify(issues))
    .setMimeType(ContentService.MimeType.JSON);
}